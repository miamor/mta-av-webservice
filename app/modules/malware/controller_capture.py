import concurrent.futures
from app.modules.common.controller import Controller
from .capture import Capture
from sqlalchemy import text
from app.app import db
from app.settings.config import Config
import datetime
import app.settings.cf as cf
# from ..detector.detection_module import Detector
# from ..detector.sandbox import Sandbox_API
from app.utils.response import error, result
from flask_restplus import marshal
import time
import json
import os
import numpy as np
from werkzeug.utils import secure_filename

# import sys
# sys.path.insert(1, cf.__URLCHECKER_ROOT__)
# import classifier as urlclassifier

# import threading


# engine = db.create_engine(Config.SQLALCHEMY_DATABASE_URI, {})
# connection = engine.connect()


class ControllerCapture(Controller):
    def __init__(self):
        # self.sandbox = Sandbox_API(cuckoo_API=cf.cuckoo_API, SECRET_KEY=cf.cuckoo_SECRET_KEY, hash_type=cf.hash_type, timeout=cf.cuckoo_timeout)
        self.detector = Detector()
        return

    def create(self, data):
        malware = self._parse_malware(data=data, malware=None)
        db.session.add(malware)
        db.session.commit()
        return malware

    # def get(self, mode, page=0):
    #     modes = mode.split(',')
    #     print('~~~~~~ modes', modes)
    #     ar = [Capture.capture_id, Capture.file_name, Capture.file_size, Capture.hash, Capture.date_received, Capture.time_received, Capture.protocol, Capture.source_ip, Capture.destination_ip, Capture.detected_by]

    #     page_size = 30

    #     query = db.select(ar).order_by(db.desc(Capture.date_received)).order_by(db.desc(Capture.time_received))

    #     if 'benign' in modes and 'critical' in modes and 'malware' in modes:
    #         cmd_all = query
    #     el

    #     if 'benign' in modes and 'critical' not in modes and 'malware' not in modes:
    #         query = query.where(
    #             db.and_(Capture.detected_by.notlike('%static%'), Capture.detected_by.notlike('%virustotal%'), Capture.detected_by.notlike('%HAN_sec%'))
    #         )
    #     elif 'benign' in modes and 'critical' in modes and 'malware' not in modes:
    #         query = query.where(
    #             Capture.detected_by.like('%1234%')
    #         )
    #     elif 'benign' in modes and 'critical' not in modes and 'malware' in modes:
    #         query = query.where(
    #             db.or_(
    #                 db.and_(Capture.detected_by.notlike('%static%'), Capture.detected_by.notlike('%virustotal%'), Capture.detected_by.notlike('%HAN_sec%')),
    #                 db.and_(Capture.detected_by.notlike('%static%'), Capture.detected_by.notlike('%virustotal%'), Capture.detected_by.notlike('%HAN_sec%'))
    #             )if 'benign' in modes and 'critical' not in modes and 'malware' not in modes: not in modes and 'critical' in modes and 'malware' in modes:
    #         query =file_size, Capture.hash, Capture.date_received, Capture.time_received, Capture.protocol, Capture.source_ip, Capture.destination_ip, Capture.detected_by]).where(Capture.hash == object_hash).order_by(db.desc(Capture.capture_id)) query.where(
    #             db.or_(
    #                 Capture.detected_by.like('%1234%'),
    #                 db.and_(Capture.detected_by.notlike('%static%'), Capture.detected_by.notlike('%virustotal%'), Capture.detected_by.notlike('%HAN_sec%'))
    #             )
    #         )
    #     elif 'benign' not in modes and 'critical' not in modes and 'malware' in modes:
    #         query = query.where(
    #             db.and_(Capture.detected_by.notlike('%static%'), Capture.detected_by.notlike('%virustotal%'), Capture.detected_by.notlike('%HAN_sec%'))
    #         )

    #     query = query.order_by(db.desc(Capture.date_received)).order_by(db.desc(Capture.time_received))
    #     query = query.limit(page_size).offset(page*page_size)

    #     print('~~ query', query)

    # engine = db.create_engine(Config.SQLALCHEMY_DATABASE_URI, {})
    # connection = engine.connect()

    #     res_list = connection.execute(query).fetchall()

    #     return res_list

    def get_query(self, mode, filters=None):
        modes = mode.split(',')
        # print('~~~~~~ modes', modes)

        cond = []
        if 'benign' in modes and 'critical' not in modes and 'malware' not in modes:
            cond.append(
                "detected_by not like '%static%' and detected_by not like '%virustotal%' and detected_by not like '%HAN_sec%' and detected_by not like '%cuckoo%'")

        for key in filters:
            if key not in ['types', 'mode', 'p', 'page']:
                print(key, filters[key])
                cond.append("{} = '{}'".format(key, filters[key]))

        if len(cond) > 0:
            cond_str = 'where ' + (' and '.join(cond))
        else:
            cond_str = ''
        cmd = "select capture_id, file_name, file_size, hash, source_ip, destination_ip, protocol, date_received, time_received, detected_by from capture " + cond_str+" order by date_received desc, time_received desc"
        # print('cmd', cmd)

        return cmd

    def count_all(self, cmd):
        engine = db.create_engine(Config.SQLALCHEMY_DATABASE_URI, {})
        connection = engine.connect()
        total = int(connection.execute(cmd).scalar())
        print('~~total', total)
        return total

    def get(self, cmd, page=0):
        page_size = 30
        start = page*page_size
        end = (page+1)*page_size

        cmd = cmd + " limit "+str(start)+", "+str(end)
        print('** [get] cmd', cmd)

        engine = db.create_engine(Config.SQLALCHEMY_DATABASE_URI, {})
        connection = engine.connect()

        malwares = connection.execute(cmd).fetchall()

        return malwares


    def count_total(self):
        query = db.func.count(Capture.capture_id)

        engine = db.create_engine(Config.SQLALCHEMY_DATABASE_URI, {})
        connection = engine.connect()

        total = int(connection.execute(query).scalar())
        print('~~total', total)
        return total

    def get_by_id(self, object_id):
        malware = Capture.query.filter_by(capture_id=object_id).first()
        return malware

    def get_report_by_id(self, report_id):
        # read report (if exist) to get behaviors
        report_path = cf.__CUCKOO_REPORT_DIR__ + \
            '/{}/reports/report.json'.format(report_id)
        print('report_path', report_path)
        with open(report_path, 'r') as f:
            return json.load(f)
        return {}

    def get_by_hash(self, object_hash, mode=0):
        # if mode == 2:
        #     malwares = Capture.query().filter_by(hash=object_hash).order_by(text('capture_id desc')).all()
        # else:
        #     malwares = Capture.query.filter_by(hash=object_hash).order_by(text('capture_id desc')).all()
        # print('~~~~~~ mode', mode)
        if mode == 2:
            cmd = db.select([Capture.capture_id, Capture.file_name, Capture.file_size, Capture.hash, Capture.date_received, Capture.time_received, Capture.protocol,
                             Capture.source_ip, Capture.destination_ip, Capture.detected_by]).where(Capture.hash == object_hash).order_by(db.desc(Capture.capture_id))
            print('cmd', cmd)
        else:
            cmd = db.select([Capture.capture_id, Capture.file_name, Capture.file_size, Capture.hash, Capture.date_received, Capture.time_received, Capture.protocol,
                             Capture.source_ip, Capture.destination_ip, Capture.detected_by]).where(Capture.hash == object_hash).order_by(db.desc(Capture.capture_id))

        engine = db.create_engine(Config.SQLALCHEMY_DATABASE_URI, {})
        connection = engine.connect()

        malwares = connection.execute(cmd).fetchall()
        return malwares

    def update(self, object_id, data):
        malware = Capture.query.filter_by(malware_id=object_id).first()
        malware = self._parse_malware(data=data, malware=malware)
        db.session.commit()
        return malware

    def delete(self, object_id):
        malware = Capture.query.filter_by(malware_id=object_id).first()
        db.session.delete(malware)
        db.session.commit()

    def gen_text_data(self, top_ip_mal, top_ip_send, top_ip_rev_mal, stat_date_tot):
        top_mal = []
        top_rev_mal = []
        top_send = []

        for r in top_ip_mal:
            top_mal.append({'ip': r[1], 'total': r[0]})
        for r in top_ip_send:
            top_send.append({'ip': r[1], 'total': r[0]})
        for r in top_ip_rev_mal:
            top_rev_mal.append({'ip': r[1], 'total': r[0]})

        texts = {
            'top_ip_mal': top_mal,
            'top_ip_send': top_send,
            'top_ip_rev_mal': top_rev_mal
        }

        return texts

    def gen_chart_data(self, top_ip_mal, top_ip_send, top_ip_rev_mal, stat_date_tot):
        top_mal_data = []
        top_mal_cat = []
        top_rev_mal_data = []
        top_rev_mal_cat = []
        top_send_data = []
        top_send_cat = []

        for r in top_ip_mal:
            if r[0] > 0:
                top_mal_data.append(r[0])
                top_mal_cat.append(r[1])
        for r in top_ip_send:
            # top_send.append({'r': r[1], 'total': r[0]})
            if r[0] > 0:
                top_send_data.append(r[0])
                top_send_cat.append(r[1])
        for r in top_ip_rev_mal:
            # top_rev_mal.append({'r': r[1], 'total': r[0]})
            if r[0] > 0:
                top_rev_mal_data.append(r[0])
                top_rev_mal_cat.append(r[1])

        # print('top_ip_msal', top_ip_mal)

        top_mal = {
            'series': [{
                'data': top_mal_data
            }],
            'options': {
                'plotOptions': {
                    'bar': {
                        'horizontal': True,
                    }
                },
                'dataLabels': {
                    'enabled': False
                },
                'xaxis': {
                    'categories': top_mal_cat,
                }
            },
        }

        top_rev_mal = {
            'series': [{
                'data': top_rev_mal_data
            }],
            'options': {
                'plotOptions': {
                    'bar': {
                        'horizontal': True,
                    }
                },
                'dataLabels': {
                    'enabled': False
                },
                'xaxis': {
                    'categories': top_rev_mal_cat,
                }
            },
        }

        top_send = {
            'series': [{
                'data': top_send_data
            }],
            'options': {
                'plotOptions': {
                    'bar': {
                        'horizontal': True,
                    }
                },
                'dataLabels': {
                    'enabled': False
                },
                'xaxis': {
                    'categories': top_send_cat,
                }
            },
        }

        charts = {
            'top_ip_mal': top_mal,
            'top_ip_send': top_send,
            'top_ip_rev_mal': top_rev_mal
        }

        return charts

    def stat(self):
        # malwares_num = Capture.query.filter(Capture.detected_by != '').with_entities(Capture.hash).count()  # + 1324#distinct().count()

        malwares_num = Capture.query.filter(db.or_(
            Capture.detected_by.like('%virustotal%'),
            Capture.detected_by.like('%static%'),
            Capture.detected_by.like('%HAN_sec%')
        )).with_entities(Capture.hash).count()

        # warnings_num = Capture.query.filter(db.and_(Capture.detected_by != '', Capture.detected_by.notlike('%virustotal%'), Capture.detected_by.notlike('%static%'), Capture.detected_by.notlike('%HAN_sec%'))).with_entities(Capture.hash).count()  # + 1324#distinct().count()
        # benigns_num = Capture.query.filter(Capture.detected_by == '').with_entities(Capture.hash).count()  # + 1324#distinct().count()

        warnings_num = Capture.query.filter(
            Capture.detected_by.like('%cuckoo%')
        ).with_entities(Capture.hash).count()

        benigns_num = Capture.query.filter(db.and_(
            Capture.detected_by.notlike('%virustotal%'),
            Capture.detected_by.notlike('%static%'),
            Capture.detected_by.notlike('%HAN_sec%'),
            Capture.detected_by.notlike('%cuckoo%')
        )).with_entities(Capture.hash).count()

        ip_malwares_num = Capture.query.filter(
            Capture.detected_by != '').with_entities(Capture.source_ip).distinct().count()

        # captured protocol
        captured_protocol_cmd = db.select([Capture.protocol, db.func.count(
            Capture.capture_id).label('count_protocol')]).group_by(Capture.protocol)
        print('captured_protocol_cmd', captured_protocol_cmd)

        # attacked protocol

        # top_ip_mal = Capture.query.filter(Capture.detected_by != '').with_entities(Capture.source_ip).distinct()
        top_ip_mal_cmd = db.select([db.func.sum(db.case(
            [(db.or_(
                Capture.detected_by.like('%virustotal%'),
                Capture.detected_by.like('%static%'),
                Capture.detected_by.like('%HAN_sec%')
            ), 1)], else_=0)
        ).label('malwares_found'), Capture.source_ip]).where(Capture.source_ip.isnot(None)).group_by(Capture.source_ip).order_by(db.desc('malwares_found')).limit(5)

        top_ip_send_cmd = db.select([db.func.sum(Capture.file_size).label('bytes_sent'), Capture.source_ip]).group_by(
            Capture.source_ip).order_by(db.desc('bytes_sent')).order_by(db.desc('bytes_sent')).limit(5)

        top_ip_rev_mal_cmd = db.select([db.func.sum(db.case(
            [(db.or_(
                Capture.detected_by.like('%virustotal%'),
                Capture.detected_by.like('%static%'),
                Capture.detected_by.like('%HAN_sec%'),
            ), 1)], else_=0)).label('malwares_found'),
            Capture.destination_ip]).group_by(Capture.destination_ip).where(Capture.destination_ip.isnot(None)).order_by(db.desc('malwares_found')).limit(5)
        # print('~~~~ top_ip_mal_cmd', top_ip_mal_cmd)
        # print('~~~~ top_ip_rev_mal_cmd', top_ip_rev_mal_cmd)

        stat_by_date_tot_cmd = db.select([
            # db.func.count(Capture.capture_id).label('total_files'),

            # db.func.sum(db.case([(db.or_(Capture.detected_by == '', db.and_(Capture.detected_by.notlike('%virustotal%'), Capture.detected_by.notlike('%static%'), Capture.detected_by.notlike('%HAN_sec%'))), 1)], else_=0)).label('normals_found'),
            # db.func.sum(db.case([(Capture.detected_by != '', 1)], else_=0)).label('malwares_found'),


            # with warnings
            # db.func.sum(db.case([(Capture.detected_by == '', 1)], else_=0)).label('normals_found'),

            # db.func.sum(db.case([(db.or_(Capture.detected_by.like('%virustotal%'), Capture.detected_by.like('%static%'), Capture.detected_by.like('%HAN_sec%')), 1)], else_=0)).label('malwares_found'),

            # db.func.sum(db.case([(db.and_(Capture.detected_by != '', Capture.detected_by.notlike('%virustotal%'), Capture.detected_by.notlike('%static%'), Capture.detected_by.notlike('%HAN_sec%')), 1)], else_=0)).label('warnings_found'),

            db.func.sum(db.case(
                [(db.and_(
                    Capture.detected_by.notlike('%virustotal%'),
                    Capture.detected_by.notlike('%static%'),
                    Capture.detected_by.notlike('%HAN_sec%'),
                    Capture.detected_by.notlike('%cuckoo%')
                ), 1)], else_=0)
            ).label('normals_found'),

            db.func.sum(db.case(
                [(db.or_(
                    Capture.detected_by.like('%virustotal%'),
                    Capture.detected_by.like('%static%'),
                    Capture.detected_by.like('%HAN_sec%')
                ), 1)], else_=0)
            ).label('malwares_found'),

            db.func.sum(db.case(
                [(Capture.detected_by.like('%cuckoo%'), 1)], else_=0)
            ).label('warnings_found'),

            # db.func.MAX(Capture.time_received).label('time')
            db.func.FROM_UNIXTIME(db.func.FLOOR(db.func.UNIX_TIMESTAMP(
                # Capture.time_received
                db.func.timestamp(Capture.date_received, Capture.time_received)
            )/30000)*30000).label('time')

        ]).group_by(
            # db.func.MINUTE(Capture.time_received)
            'time'
        ).where(Capture.date_received.isnot(None)).order_by(db.asc('time'))

        # stat_by_date_mal_cmd = db.select([db.func.count(Capture.capture_id).label('mal_num'), db.func.MAX(Capture.time_received).label('time')]).group_by(db.func.MINUTE(Capture.time_received)).where(db.and_(Capture.date_received.isnot(None), Capture.detected_by != '')).order_by(db.asc('time'))

        # top_ip_mal = db.session.query(top_ip_mal_cmd)

        engine = db.create_engine(Config.SQLALCHEMY_DATABASE_URI, {})
        connection = engine.connect()

        top_ip_mal = connection.execute(top_ip_mal_cmd).fetchall()
        top_ip_send = connection.execute(top_ip_send_cmd).fetchall()
        top_ip_rev_mal = connection.execute(top_ip_rev_mal_cmd).fetchall()
        stat_date_tot = connection.execute(stat_by_date_tot_cmd).fetchall()
        # stat_date_mal = connection.execute(stat_by_date_mal_cmd).fetchall()

        captured_protocol_tuple = connection.execute(
            captured_protocol_cmd).fetchall()
        captured_protocol = {'http': 0, 'ftp': 0, 'smb': 0}
        for r in captured_protocol_tuple:
            captured_protocol[r[0]] = r[1]
        print('** captured_protocol', captured_protocol)

        # stat_data = self.gen_chart_data(top_ip_mal, top_ip_send, top_ip_rev_mal, stat_date_tot)
        stat_data = self.gen_text_data(
            top_ip_mal, top_ip_send, top_ip_rev_mal, stat_date_tot)

        stat_by_date_data_normal = []
        stat_by_date_data_mal = []
        stat_by_date_data_warnings = []
        stat_by_date_cat = []
        # print('stat_date_tot', stat_date_tot)
        # print('stat_date_mal', stat_date_mal)
        for k, r in enumerate(stat_date_tot):
            # stat_by_date.append({'date': r[1], 'total': r[0]})
            # r_m = stat_date_mal[k]
            # print(r[0], '~~~~~', r_m[0])
            if r[0] > 0 or r[1] > 0:
                stat_by_date_data_normal.append(r[0])
                # print('r[1]', r[1])
                stat_by_date_data_mal.append(r[1])
                stat_by_date_data_warnings.append(r[2])
                # stat_by_date_cat.append(r[2].strftime('%D, %H:%M'))
                stat_by_date_cat.append(r[3].strftime('%d/%m, %H:%M'))
                # value = datetime.timedelta(0, 64800)
                # time_val = (datetime.datetime.min + r[2]).time()
                # stat_by_date_cat.append(time_val)
        # print('stat_by_date_cat', stat_by_date_cat)

        stat_by_date = {
            'series': [{
                # 'name': 'Total files',
                # 'type': 'column',
                'name': 'Benigns',
                'data': stat_by_date_data_normal
            }, {
                'name': 'Malwares',
                # 'type': 'line',
                'data': stat_by_date_data_mal
            }, {
                'name': 'Criticals',
                # 'type': 'line',
                'data': stat_by_date_data_warnings
            }],
            'cat': stat_by_date_cat
        }

        stat_data['stat_by_date'] = stat_by_date

        # print('stat_data', stat_data)

        stat_data['num'] = {
            'malwares_num': malwares_num,
            'warnings_num': warnings_num,
            'benigns_num': benigns_num,
            'ip_malwares_num': ip_malwares_num
        }

        stat_data['captured_protocol'] = captured_protocol

        return stat_data

    def _parse_malware(self, data, malware=None):
        file_name, file_size, file_extension, file_path, hash, md5, sha1, sha256, sha512, ssdeep, report_path, report_id, date_created, date_modified, date_sent, time_sent, date_received, time_received, collection_date, collection_type, source_ip, destination_ip, source_url, destination_url, hostname, protocol, source_email, destination_email, source_country, destination_country, malware_type, source_dns, destination_dns, entropy, description, detected_by, detector_output, scan_time, warning_level = None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None
        # print('~~ data _parse_malware', data)
        if 'file_name' in data:
            file_name = data['file_name']
        if 'file_size' in data:
            file_size = data['file_size']
        if 'file_extension' in data:
            file_extension = data['file_extension']
        if 'file_path' in data:
            file_path = data['file_path']

        if 'hash' in data:
            hash = data['hash']
        if 'md5' in data:
            md5 = data['md5']
        if 'sha1' in data:
            sha1 = data['sha1']
        if 'sha256' in data:
            sha256 = data['sha256']
        if 'sha512' in data:
            sha512 = data['sha512']
        if 'ssdeep' in data:
            ssdeep = data['ssdeep']
        if 'report_path' in data:
            report_path = data['report_path']
        if 'report_id' in data:
            report_id = data['report_id']

        if 'date_created' in data:
            date_created = data['date_created']
        if 'date_modified' in data:
            date_modified = data['date_modified']

        if 'date_sent' in data:
            date_sent = data['date_sent']
        if 'time_sent' in data:
            time_sent = data['time_sent']
        if 'date_received' in data:
            date_received = data['date_received']
        if 'time_received' in data:
            time_received = data['time_received']

        if 'collection_date' in data:
            collection_date = data['collection_date']
        if 'collection_type' in data:
            collection_type = data['collection_type']
        if 'source_ip' in data:
            source_ip = data['source_ip']
        if 'destination_ip' in data:
            destination_ip = data['destination_ip']

        if 'source_url' in data:
            source_url = data['source_url']
        if 'destination_url' in data:
            destination_url = data['destination_url']
        if 'hostname' in data:
            hostname = data['hostname']
        if 'protocol' in data:
            protocol = data['protocol']

        if 'source_email' in data:
            source_email = data['source_email']
        if 'destination_email' in data:
            destination_email = data['destination_email']
        if 'source_country' in data:
            source_country = data['source_country']
        if 'destination_country' in data:
            destination_country = data['destination_country']

        if 'malware_type' in data:
            malware_type = data['malware_type']
        if 'source_dns' in data:
            source_dns = data['source_dns']
        if 'destination_dns' in data:
            destination_dns = data['destination_dns']
        if 'entropy' in data:
            entropy = data['entropy']

        if 'description' in data:
            description = data['description']
        if 'detected_by' in data:
            detected_by = data['detected_by']
        if 'detector_output' in data:
            detector_output = data['detector_output']
        if 'warning_level' in data:
            warning_level = data['warning_level']
        if 'scan_time' in data:
            scan_time = data['scan_time']

        if malware is None:
            malware = Capture(file_name=file_name, file_size=file_size, file_extension=file_extension, hash=hash,
                              md5=md5, sha1=sha1, sha256=sha256, sha512=sha512, ssdeep=ssdeep,
                              report_path=report_path, report_id=report_id,
                              date_created=date_created, date_modified=date_modified, date_sent=date_sent,
                              date_received=date_received, time_received=time_received, collection_date=collection_date,
                              collection_type=collection_type, source_ip=source_ip, destination_ip=destination_ip,
                              source_url=source_url, destination_url=destination_url, hostname=hostname,
                              protocol=protocol, source_email=source_email, destination_email=destination_email,
                              source_country=source_country, destination_country=destination_country,
                              malware_type=malware_type, source_dns=source_dns, destination_dns=destination_dns,
                              entropy=entropy, description=description,
                              detected_by=detected_by, detector_output=detector_output,
                              scan_time=scan_time,
                              warning_level=warning_level)
        else:
            malware.file_name = file_name
            malware.file_size = file_size
            malware.file_extension = file_extension
            malware.file_path = file_path

            malware.hash = hash
            malware.md5 = md5
            malware.sha1 = sha1
            malware.sha256 = sha256
            malware.sha512 = sha512
            malware.ssdeep = ssdeep
            malware.report_path = report_path
            malware.report_id = report_id

            malware.date_created = date_created
            malware.date_modified = date_modified

            malware.date_sent = date_sent
            malware.time_sent = time_sent
            malware.date_received = date_received
            malware.time_received = time_received

            malware.collection_date = collection_date
            malware.collection_type = collection_type
            malware.source_ip = source_ip
            malware.destination_ip = destination_ip

            malware.source_url = source_url
            malware.destination_url = destination_url
            malware.hostname = hostname
            malware.protocol = protocol

            malware.source_email = source_email
            malware.destination_email = destination_email
            malware.source_country = source_country
            malware.destination_country = destination_country

            malware.malware_type = malware_type
            malware.source_dns = source_dns
            malware.destination_dns = destination_dns
            malware.entropy = entropy

            malware.description = description
            malware.detected_by = detected_by
            malware.detector_output = detector_output
            malware.scan_time = scan_time
            malware.warning_level = warning_level
        return malware

    # def check_url(self, urls):
    #     print("[check_url] urls", urls)
    #     begin_time = time.time()
    #     res_url = []
    #     empty_url_idx = []
    #     len_orig_urls = len(urls)
    #     for k in range(len_orig_urls):
    #         url = urls[k]
    #         if url == '':
    #             urls.remove(url)
    #             empty_url_idx.append(k)

    #     if len(urls) > 0:
    #         is_malicious_urls = urlclassifier.classifier(urls)
    #         for idx in empty_url_idx:
    #             # is_malicious_urls.insert(idx, 0)
    #             np.insert(is_malicious_urls, idx, 0)
    #     else:
    #         is_malicious_urls = np.array([0] * len_orig_urls)

    #     return is_malicious_urls, time.time()-begin_time

    def submit_cuckoo(self, filepaths):
        task_ids = []
        for filepath in filepaths:
            task_id = self.detector.run_sandbox(cf.CAPTURED_FOLDER+filepath)
            task_ids.append(task_id)

        return task_ids


    def upload_file_submit_cuckoo(self, files):

        # filenames = []
        filepaths = []
        task_ids = []

        for i in range(len(files)):
            file = files[i]

            if file.filename == "":
                continue

            # if file and allowed_file(file.filename):
            if file:
                # upload file
                filename = secure_filename(file.filename)
                filepath = os.path.join(cf.UPLOAD_FOLDER, filename)
                file.save(filepath)

                # filenames.append(filename)
                filepaths.append(filepath)

                # submit to cuckoo
                task_id = self.detector.run_sandbox(filepath)
                task_ids.append(task_id)

        return filepaths, task_ids

    def check(self, filepaths, task_ids, task_data):
        print('[check] task_ids', task_ids, 'filepaths', filepaths)
        # Run detector core
        # to get report
        # and cukoo/virustotal result
        task_ids, resp, scan_time = self.detector.run(filepaths, task_ids)

        # start a thread for other detectors
        # t1 = threading.Thread(target=detector.run_han, args=(task_ids))
        # t1.start()
        print('resp', resp)
        # with concurrent.futures.ThreadPoolExecutor() as executor:
        #     future_han = executor.submit(self.detector.run_han, task_ids, resp)
        #     resp_all, scan_time = future_han.result()
        if True:
            resp_all, scan_time = self.detector.run_han(task_ids, resp)
            print('** HAN return ', resp_all, scan_time)

            # future_ngram = executor.submit(detector.run_ngram, filepaths, task_ids, resp_all)
            # resp_all, scan_time = future_ngram.result()
            # print('** NGRAM return ', resp_all, scan_time)

            # future_img_bytes = executor.submit(detector.run_img_bytes, filepaths, task_ids, resp_all)
            # resp_all, scan_time = future_img_bytes.result()
            # print('** img_bytes return ', resp_all, scan_time)

            # future_asm = executor.submit(detector.run_asm, filepaths, task_ids, resp_all)
            # resp_all, scan_time = future_asm.result()
            # print('** asm return ', resp_all, scan_time)

            for i in range(len(task_data)):
                # filepath = task_data[i]['file_path']
                # task_id = task_data[i]['task_id']

                task_id = task_ids[i]
                filepath = filepaths[i]
                # filename = filenames[i]

                filename = filepath.split('/')[-1]
                res = resp_all[0][task_id]
                engines_detected = resp_all[1][task_id]
                detector_output = resp_all[2][task_id]
                # print('res', res)
                # if res['is_malware'] == 1:
                # print('i=', i, task_data[i])
                task_data[i]['file_name'] = filename
                task_data[i]['file_size'] = os.path.getsize(filepath)
                task_data[i]['file_extension'] = filepath.split('.')[-1]
                # task_data[i]['file_path'] = filepath
                task_data[i]['report_path'] = res['report_path']
                task_data[i]['report_id'] = res['report_id']

                task_data[i]['hash'] = res['hash_value']
                task_data[i]['md5'] = res['md5']
                task_data[i]['sha1'] = res['sha1']
                task_data[i]['sha256'] = res['sha256']
                task_data[i]['sha512'] = res['sha512']
                task_data[i]['ssdeep'] = res['ssdeep']

                # task_data[i]['source_ip'] = request.remote_addr
                task_data[i]['detected_by'] = ','.join(engines_detected)
                task_data[i]['detector_output'] = json.dumps(
                    detector_output)
                task_data[i]['scan_time'] = scan_time

                if 'date_received' not in task_data[i]:
                    task_data[i]['date_received'] = time.strftime('%Y-%m-%d')
                if 'time_received' not in task_data[i]:
                    task_data[i]['time_received'] = time.strftime('%H:%M:%S')

                # print('**** data insert: ', task_data[i])
                controller = ControllerCapture()
                malware = controller.create(data=task_data[i])
                print('**** malware inserted', i, malware)

            # print('resp_all[0]', resp_all[0])
            return result(message='Check completed', data=resp_all[0])

        # print('resp', resp)
        # return result(message='Check completed. File clean!')

    def gen_report(self, filepaths, filenames):
        task_ids = []

        # Run sandbox
        task_ids, _, _ = self.detector.run_(filenames, filepaths)

        if True:
            print('~~ [/gen_report] task_ids', task_ids)
            return result(message='Check completed', data=task_ids)
