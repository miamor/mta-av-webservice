from flask_restplus import Resource
from app.modules.common.decorator import token_required, admin_token_required
# from .capture import Capture
from .dto_capture import DtoCapture
from .controller_capture import ControllerCapture
from flask import request, jsonify, abort
import os
import app.settings.cf as cf
# from werkzeug.datastructures import FileStorage
import datetime
from werkzeug.utils import secure_filename

api = DtoCapture.api
capture = DtoCapture.model


@api.route('')
class CaptureList(Resource):
    @api.marshal_list_with(capture)
    def get(self):
        data = request.args
        mode = int(data['mode']) if 'mode' in data else 0
        print('mode = ', mode)
        controller = ControllerCapture()
        return controller.get(mode)

    @api.expect(capture)
    @api.marshal_with(capture)
    def post(self):
        # data = api.payload
        # data = request.form.to_dict(flat=True)
        data = request.get_json()
        data['hash'] = data['md5']
        print('data post METHOD~~~~', data)
        controller = ControllerCapture()
        return controller.create(data=data)


@api.route('/check')
class CaptureCheck(Resource):
    # @api.marshal_with(capture)
    def post(self):
        print('request.files', request.files)
        print('request.remote_addr', request.remote_addr)
        print('request.form', request.form)

        post_data = request.form.to_dict(flat=False)
        print('post_data', post_data)
        task_data = []
        for i in range(len(post_data['destination_ip'])):
            tmp = {}
            for field in post_data:
                tmp[field] = post_data[field][i]
            if 'md5' in post_data:
                tmp['hash'] = post_data['md5'][i]
            if 'date_received' in post_data:
                tmp['date_received'] = post_data['date_received'][i]
            if 'time_received' in post_data:
                tmp['time_received'] = post_data['time_received'][i]
            task_data.append(tmp)
        print('** task_data', task_data)

        # check if the post request has the file part
        if 'files[]' not in request.files:
            resp = jsonify(
                {"status": "error", "status_msg": "No file part in the request"})
            resp.status_code = 400
            return resp

        files = request.files.getlist('files[]')

        filenames = []
        filepaths = []

        for i in range(len(files)):
            file = files[i]

            if file.filename == "":
                continue

            # if file and allowed_file(file.filename):
            if file:
                filename = secure_filename(file.filename)
                filepath = os.path.join(cf.UPLOAD_FOLDER, filename)
                file.save(filepath)

                filenames.append(filename)
                filepaths.append(filepath)


        controller = ControllerCapture()
        return controller.check(filepaths=filepaths, filenames=filenames, task_data=task_data)


@api.route('/download_file')
class CaptureDownload(Resource):
    # @api.marshal_with(capture)
    def get(self):
        path = '/home/mtaav/CODE/mta-av-webservice/Update'
        lstFile = os.listdir(path)
        date = str(datetime.datetime.now().strftime('%d-%m-%Y'))
        for item in lstFile:
            # print(item.split('.')[0])
            if (date == item.split('.')[0]):
                return send_file(os.path.join(path, item), as_attachment=True)
        abort(404, 'not available')


@api.route('/<int:cid>')
class Capture(Resource):
    @api.marshal_with(capture)
    def get(self, cid):
        controller = ControllerCapture()
        return controller.get_by_id(object_id=cid)

    # @api.expect(capture)
    # def put(self, cid):
    #     data = api.payload
    #     controller = ControllerCapture()
    #     return controller.update(object_id=cid, data=data)

    def delete(self, cid):
        controller = ControllerCapture()
        return controller.delete(object_id=cid)


@api.route('/report/<int:report_id>')
class CaptureReport(Resource):
    def get(self, report_id):
        controller = ControllerCapture()
        return controller.get_report_by_id(report_id=report_id)


@api.route('/stat')
class CaptureStat(Resource):
    def get(self):
        controller = ControllerCapture()
        # mal_num, ip_mal_num, stat_by_date, top_ip_mal, top_ip_send, top_ip_rev_mal = controller.stat()
        mal_num, warnings_num, bgn_num, ip_mal_num, charts = controller.stat()
        resp = jsonify({
            "status": "success",
            "malwares_num": mal_num,
            "warnings_num": warnings_num,
            "benigns_num": bgn_num,
            "ip_malwares_num": ip_mal_num,
            # "stat_by_date": stat_by_date,
            # "top_ip_mal": top_ip_mal,
            # "top_ip_send": top_ip_send,
            # "top_ip_rev_mal": top_ip_rev_mal
            "charts": charts
        })
        resp.status_code = 200
        return resp


@api.route('/search/<string:capture_hash>')
class CaptureSearchHash(Resource):
    @api.marshal_with(capture)
    def get(self, capture_hash):
        data = request.args
        mode = int(data['mode']) if 'mode' in data else 0
        print('mode = ', mode)
        controller = ControllerCapture()
        return controller.get_by_hash(object_hash=capture_hash, mode=mode)

@api.route('/search')
class CaptureSearch(Resource):
    @api.marshal_with(capture)
    def get(self):
        data = request.args
        mode = int(data['mode']) if 'mode' in data else 0
        controller = ControllerCapture()
        print('data', data)
        return controller.get_filter(mode=mode, filters=data)

#     @api.expect(capture)
#     def put(self, capture_hash):
#         data = api.payload
#         controller = ControllerCapture()
#         return controller.update(object_hash=capture_hash, data=data)

#     def delete(self, capture_hash):
#         controller = ControllerCapture()
#         return controller.delete(object_hash=capture_hash)





@api.route('/gen_report')
class CaptureGenReport(Resource):
    # @api.marshal_with(capture)
    def post(self):
        print('request.files', request.files)
        print('request.remote_addr', request.remote_addr)
        print('request.form', request.form)

        # check if the post request has the file part
        if 'files[]' not in request.files:
            resp = jsonify(
                {"status": "error", "status_msg": "No file part in the request"})
            resp.status_code = 400
            return resp

        files = request.files.getlist('files[]')

        filenames = []
        filepaths = []
        for i in range(len(files)):
            file = files[i]

            if file.filename == "":
                continue

            # if file and allowed_file(file.filename):
            if file:
                filename = secure_filename(file.filename)
                filepath = os.path.join(cf.UPLOAD_FOLDER, filename)
                file.save(filepath)

                filenames.append(filename)
                filepaths.append(filepath)


        controller = ControllerCapture()
        return controller.gen_report(filepaths=filepaths, filenames=filenames)
