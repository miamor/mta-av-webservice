from flask_restplus import Resource
from app.modules.common.decorator import token_required, admin_token_required
# from .capture import Capture
from .dto_capture import DtoCapture
from .controller_capture import ControllerCapture
from flask import request, jsonify, abort
from werkzeug.utils import secure_filename
import os
import app.settings.cf as cf
# from werkzeug.datastructures import FileStorage
from ..detector.detection_module import Detector
from app.utils.response import error, result
from flask_restplus import marshal
import time
import datetime

api = DtoCapture.api
capture = DtoCapture.model


@api.route('')
class CaptureList(Resource):
    @api.marshal_list_with(capture)
    def get(self):
        data = request.args
        mode = int(data['mode']) if 'mode' in data else 0
        print('mode = ', mode)
        controller = ControllerCapture()
        return controller.get(mode)

    @api.expect(capture)
    @api.marshal_with(capture)
    def post(self):
        # data = api.payload
        # data = request.form.to_dict(flat=True)
        data = request.get_json()
        print('data post METHOD~~~~', data)
        controller = ControllerCapture()
        return controller.create(data=data)


@api.route('/check')
class CaptureCheck(Resource):
    # @api.marshal_with(capture)
    def post(self):
        print('request.files', request.files)
        print('request.remote_addr', request.remote_addr)
        print('request.form', request.form)

        data = request.form.to_dict(flat=False)
        # data = data['data']
        print('** data', data)

        # check if the post request has the file part
        if 'files[]' not in request.files:
            resp = jsonify(
                {"status": "error", "status_msg": "No file part in the request"})
            resp.status_code = 400
            return resp

        files = request.files.getlist('files[]')
        task_ids = []
        map_task_file = {}

        detector = Detector()
        for file in files:
            if file.filename == "":
                continue

            done_report = False

            # if file and allowed_file(file.filename):
            if file:
                filename = secure_filename(file.filename)
                filepath = os.path.join(cf.UPLOAD_FOLDER, filename)
                file.save(filepath)

                # Run analysis
                task_id, resp, scan_time = detector.run(filename, filepath)

                res = resp[0][task_id]
                engines_detected = resp[1]
                print('res', res)
                # if res['is_malware'] == 1:
                if True:
                    data['file_name'] = filename
                    data['file_size'] = os.path.getsize(filepath)
                    data['file_extension'] = filepath.split('.')[-1]
                    data['file_path'] = filepath
                    data['report_path'] = res['report_path']
                    data['report_id'] = res['report_id']

                    data['hash'] = res['hash_value']
                    data['md5'] = res['md5']
                    data['sha1'] = res['sha1']
                    data['sha256'] = res['sha256']
                    data['sha512'] = res['sha512']
                    data['ssdeep'] = res['ssdeep']

                    # data['source_ip'] = request.remote_addr
                    data['detected_by'] = ','.join(engines_detected)
                    data['scan_time'] = scan_time
                    data['date_received'] = time.strftime('%Y-%m-%d')
                    data['time_received'] = time.strftime('%H:%M:%S')

                    print('**** data insert: ', data)
                    controller = ControllerCapture()
                    malware = controller.create(data=data)
                    return result(message='Check completed. Malware detected!', data=resp[0])
                else:
                    return result(message='Check completed. File clean!', data=resp[0])

# update


@api.route('/download_file')
class CaptureDownload(Resource):
    # @api.marshal_with(capture)
    def get(self):
        path = '/home/mtaav/CODE/mta-av-webservice/Update'
        lstFile = os.listdir(path)
        date = str(datetime.datetime.now().strftime('%d-%m-%Y'))
        for item in lstFile:
            # print(item.split('.')[0])
            if (date == item.split('.')[0]):
                return send_file(os.path.join(path, item), as_attachment=True)
        abort(404, 'not available')


@api.route('/<int:cid>')
class Capture(Resource):
    @api.marshal_with(capture)
    def get(self, cid):
        controller = ControllerCapture()
        return controller.get_by_id(object_id=cid)

    # @api.expect(capture)
    # def put(self, cid):
    #     data = api.payload
    #     controller = ControllerCapture()
    #     return controller.update(object_id=cid, data=data)

    def delete(self, cid):
        controller = ControllerCapture()
        return controller.delete(object_id=cid)


@api.route('/report/<int:report_id>')
class CaptureReport(Resource):
    def get(self, report_id):
        controller = ControllerCapture()
        return controller.get_report_by_id(report_id=report_id)


@api.route('/stat')
class CaptureStat(Resource):
    def get(self):
        controller = ControllerCapture()
        # mal_num, ip_mal_num, stat_by_date, top_ip_mal, top_ip_send, top_ip_rev_mal = controller.stat()
        mal_num, ip_mal_num, charts = controller.stat()
        resp = jsonify({
            "status": "success",
            "malwares_num": mal_num,
            "ip_malwares_num": ip_mal_num,
            # "stat_by_date": stat_by_date,
            # "top_ip_mal": top_ip_mal,
            # "top_ip_send": top_ip_send,
            # "top_ip_rev_mal": top_ip_rev_mal
            "charts": charts
        })
        resp.status_code = 200
        return resp


@api.route('/search/<string:capture_hash>')
class CaptureSearchHash(Resource):
    @api.marshal_with(capture)
    def get(self, capture_hash):
        controller = ControllerCapture()
        return controller.get_by_hash(object_hash=capture_hash)

#     @api.expect(capture)
#     def put(self, capture_hash):
#         data = api.payload
#         controller = ControllerCapture()
#         return controller.update(object_hash=capture_hash, data=data)

#     def delete(self, capture_hash):
#         controller = ControllerCapture()
#         return controller.delete(object_hash=capture_hash)
